<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0f172a">
  <title>WebMCP PoC — Hospital Explorer</title>
  <script>
    // Remove native navigator.modelContext so @mcp-b/global polyfill
    // can install its own version with MCP bridge support
    if ('modelContext' in navigator) {
      delete navigator.modelContext;
      // If non-configurable, override via defineProperty
      if ('modelContext' in navigator) {
        Object.defineProperty(navigator, 'modelContext', {
          value: undefined,
          writable: true,
          configurable: true
        });
      }
    }
  </script>
  <script src="https://unpkg.com/@mcp-b/global@latest/dist/index.iife.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --surface: #1e293b;
      --surface-alt: #334155;
      --border: #475569;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --accent: #38bdf8;
      --accent-dim: #0c4a6e;
      --risk-low: #22c55e;
      --risk-med: #f59e0b;
      --risk-high: #ef4444;
      --radius: 8px;
      --radius-lg: 12px;
      --font: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --mono: ui-monospace, 'SF Mono', SFMono-Regular, Menlo, monospace;
      --transition: 150ms ease;
    }

    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; animation: none !important; }
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100dvh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
    }

    header h1 {
      font-size: 18px;
      font-weight: 600;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-muted);
      padding: 6px 12px;
      background: var(--surface);
      border-radius: 100px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
    }

    .status-dot.active { background: var(--risk-low); }

    .layout {
      display: grid;
      grid-template-columns: 1fr 380px;
      min-height: calc(100dvh - 57px);
    }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .chat-panel { border-left: none; border-top: 1px solid var(--border); max-height: 50dvh; }
    }

    main { padding: 24px; overflow-y: auto; }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 24px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      min-height: 44px;
      padding: 0 16px;
      font-size: 14px;
      font-family: var(--font);
      color: var(--text-muted);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 100px;
      cursor: pointer;
      transition: background var(--transition), color var(--transition), border-color var(--transition);
    }

    .chip:hover { background: var(--surface-alt); color: var(--text); }
    .chip:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .chip.active { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }

    .chip-separator {
      width: 1px;
      height: 28px;
      background: var(--border);
      align-self: center;
    }

    #display { min-height: 200px; }

    /* Table view */
    .hospital-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .hospital-table th {
      text-align: left;
      padding: 10px 12px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }

    .hospital-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--surface-alt);
      white-space: nowrap;
    }

    .hospital-table tbody tr {
      cursor: pointer;
      transition: background var(--transition);
    }

    .hospital-table tbody tr:hover { background: var(--surface); }
    .hospital-table tbody tr:focus-visible { outline: 2px solid var(--accent); outline-offset: -2px; }

    .risk-badge {
      display: inline-block;
      padding: 2px 10px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 100px;
      letter-spacing: 0.04em;
    }

    .risk-badge.low { background: #052e16; color: var(--risk-low); }
    .risk-badge.medium { background: #451a03; color: var(--risk-med); }
    .risk-badge.high { background: #450a0a; color: var(--risk-high); }

    /* Chart view */
    .chart-container { max-width: 600px; }

    .chart-row {
      display: grid;
      grid-template-columns: 80px 1fr 50px;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .chart-label {
      font-size: 14px;
      font-weight: 500;
      text-align: right;
    }

    .chart-bar-track {
      height: 32px;
      background: var(--surface);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .chart-bar-fill {
      height: 100%;
      border-radius: var(--radius);
      transition: width 400ms ease;
    }

    .chart-value {
      font-size: 14px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    /* Detail view */
    .detail-card {
      max-width: 640px;
      background: var(--surface);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .detail-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--surface-alt);
    }

    .detail-header h2 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .detail-meta {
      font-size: 13px;
      color: var(--text-muted);
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: var(--surface-alt);
    }

    .detail-cell {
      padding: 16px 24px;
      background: var(--surface);
    }

    .detail-cell-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .detail-cell-value {
      font-size: 18px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .payer-bar {
      display: flex;
      height: 12px;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 8px;
    }

    .payer-bar > div { transition: width 400ms ease; }
    .payer-segment-medicaid { background: var(--risk-high); }
    .payer-segment-medicare { background: var(--risk-med); }
    .payer-segment-commercial { background: var(--risk-low); }
    .payer-segment-other { background: #8b5cf6; }

    .payer-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      padding: 16px 24px;
      font-size: 13px;
      color: var(--text-muted);
      border-top: 1px solid var(--surface-alt);
    }

    .payer-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .payer-legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .view-label {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      min-height: 44px;
      padding: 0 16px;
      font-size: 13px;
      font-family: var(--font);
      color: var(--accent);
      background: none;
      border: 1px solid var(--accent-dim);
      border-radius: var(--radius);
      cursor: pointer;
      margin-bottom: 16px;
    }

    .back-btn:hover { background: var(--accent-dim); }
    .back-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    /* Chat panel */
    .chat-panel {
      border-left: 1px solid var(--border);
      background: var(--surface);
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      padding: 16px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-muted);
      border-bottom: 1px solid var(--surface-alt);
    }

    .api-key-bar {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--surface-alt);
    }

    .api-key-bar input {
      flex: 1;
      min-height: 36px;
      padding: 0 12px;
      font-size: 13px;
      font-family: var(--mono);
      color: var(--text);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }

    .api-key-bar input::placeholder { color: var(--text-muted); }
    .api-key-bar input:focus { outline: 2px solid var(--accent); outline-offset: -1px; }

    .api-key-toggle {
      min-width: 44px;
      min-height: 36px;
      font-size: 13px;
      font-family: var(--font);
      color: var(--text-muted);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
    }

    .api-key-toggle:hover { color: var(--text); }
    .api-key-toggle:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .chat-empty {
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
      padding: 24px 16px;
      line-height: 1.6;
    }

    .msg {
      max-width: 90%;
      padding: 10px 14px;
      border-radius: var(--radius-lg);
      font-size: 13px;
      line-height: 1.5;
      word-break: break-word;
    }

    .msg-user {
      align-self: flex-end;
      background: var(--accent-dim);
      color: var(--accent);
      border-bottom-right-radius: 4px;
    }

    .msg-assistant {
      align-self: flex-start;
      background: var(--surface-alt);
      color: var(--text);
      border-bottom-left-radius: 4px;
    }

    .msg-tool {
      align-self: flex-start;
      max-width: 95%;
      padding: 8px 12px;
      font-family: var(--mono);
      font-size: 11px;
      line-height: 1.6;
      color: var(--text-muted);
      background: var(--bg);
      border: 1px solid var(--surface-alt);
      border-radius: var(--radius);
    }

    .msg-tool-name { color: var(--accent); font-weight: 600; }
    .msg-tool-result { color: var(--risk-low); }

    .msg-error {
      align-self: center;
      padding: 8px 14px;
      font-size: 12px;
      color: var(--risk-high);
      background: #450a0a;
      border-radius: var(--radius);
    }

    .chat-input-area {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-top: 1px solid var(--surface-alt);
    }

    .chat-input-area textarea {
      flex: 1;
      min-height: 44px;
      max-height: 120px;
      padding: 10px 12px;
      font-size: 14px;
      font-family: var(--font);
      color: var(--text);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      resize: none;
      line-height: 1.4;
    }

    .chat-input-area textarea::placeholder { color: var(--text-muted); }
    .chat-input-area textarea:focus { outline: 2px solid var(--accent); outline-offset: -1px; }

    .chat-send {
      min-width: 44px;
      min-height: 44px;
      font-size: 18px;
      font-family: var(--font);
      color: var(--bg);
      background: var(--accent);
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: opacity var(--transition);
    }

    .chat-send:disabled { opacity: 0.4; cursor: default; }
    .chat-send:not(:disabled):hover { opacity: 0.85; }
    .chat-send:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    @keyframes chat-spin {
      to { transform: rotate(360deg); }
    }

    .chat-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--surface-alt);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: chat-spin 0.6s linear infinite;
      align-self: flex-start;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }

    .summary-count {
      font-size: 13px;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <header>
    <h1>WebMCP PoC</h1>
    <div class="status-badge">
      <span class="status-dot" id="status-dot"></span>
      <span id="status-text">Checking...</span>
    </div>
  </header>

  <div class="layout">
    <main>
      <nav class="controls" aria-label="Filters">
        <button class="chip active" data-filter="all">All</button>
        <button class="chip" data-filter="Los Angeles">Los Angeles</button>
        <button class="chip" data-filter="San Francisco">San Francisco</button>
        <button class="chip" data-filter="Sacramento">Sacramento</button>
        <button class="chip" data-filter="San Diego">San Diego</button>
        <div class="chip-separator"></div>
        <button class="chip" data-view="chart">Risk Overview</button>
        <button class="chip" data-filter="high">High Risk Only</button>
      </nav>

      <div id="display"></div>
    </main>

    <aside class="chat-panel">
      <div class="chat-header">Chat</div>
      <div class="api-key-bar">
        <input type="password" id="api-key" placeholder="sk-ant-..." autocomplete="off" spellcheck="false" aria-label="Anthropic API key">
        <button class="api-key-toggle" id="key-toggle" aria-label="Toggle key visibility">Show</button>
      </div>
      <div class="chat-messages" id="chat-messages">
        <div class="chat-empty">Ask a question about California hospital data.</div>
      </div>
      <div class="chat-input-area">
        <textarea id="chat-input" placeholder="Ask about hospitals..." rows="1" aria-label="Chat message"></textarea>
        <button class="chat-send" id="chat-send" aria-label="Send message">&uarr;</button>
      </div>
    </aside>
  </div>

  <script>
    /* ── Dataset (representative subset of CA hospital data) ── */

    const HOSPITALS = [
      { name: "MLK Community Hospital", county: "Los Angeles", type: "General Acute", ownership: "Non-Profit", mediCalPct: 65.7, medicarePct: 18.2, commercialPct: 10.1, otherPct: 6.0, operatingMargin: -8.2, equityBurdenScore: 82, riskProbability: 0.78, licensedBeds: 131, occupancyRate: 107.5 },
      { name: "Cedars-Sinai Medical Center", county: "Los Angeles", type: "General Acute", ownership: "Non-Profit", mediCalPct: 8.3, medicarePct: 32.1, commercialPct: 51.4, otherPct: 8.2, operatingMargin: 12.1, equityBurdenScore: 14, riskProbability: 0.08, licensedBeds: 886, occupancyRate: 78.3 },
      { name: "LAC+USC Medical Center", county: "Los Angeles", type: "General Acute", ownership: "Government", mediCalPct: 72.1, medicarePct: 15.8, commercialPct: 5.2, otherPct: 6.9, operatingMargin: -11.4, equityBurdenScore: 89, riskProbability: 0.85, licensedBeds: 600, occupancyRate: 95.2 },
      { name: "Providence Holy Cross", county: "Los Angeles", type: "General Acute", ownership: "Non-Profit", mediCalPct: 38.5, medicarePct: 28.9, commercialPct: 24.6, otherPct: 8.0, operatingMargin: 1.2, equityBurdenScore: 45, riskProbability: 0.42, licensedBeds: 377, occupancyRate: 67.1 },
      { name: "Centinela Hospital", county: "Los Angeles", type: "General Acute", ownership: "For-Profit", mediCalPct: 44.2, medicarePct: 30.1, commercialPct: 18.7, otherPct: 7.0, operatingMargin: -2.3, equityBurdenScore: 58, riskProbability: 0.51, licensedBeds: 369, occupancyRate: 71.8 },
      { name: "Zuckerberg SF General", county: "San Francisco", type: "General Acute", ownership: "Government", mediCalPct: 55.3, medicarePct: 22.4, commercialPct: 14.1, otherPct: 8.2, operatingMargin: -6.7, equityBurdenScore: 74, riskProbability: 0.72, licensedBeds: 284, occupancyRate: 88.9 },
      { name: "UCSF Medical Center", county: "San Francisco", type: "General Acute", ownership: "Non-Profit", mediCalPct: 12.6, medicarePct: 29.8, commercialPct: 48.3, otherPct: 9.3, operatingMargin: 8.4, equityBurdenScore: 18, riskProbability: 0.11, licensedBeds: 600, occupancyRate: 82.1 },
      { name: "Chinese Hospital", county: "San Francisco", type: "General Acute", ownership: "Non-Profit", mediCalPct: 35.2, medicarePct: 38.4, commercialPct: 19.8, otherPct: 6.6, operatingMargin: 0.8, equityBurdenScore: 41, riskProbability: 0.38, licensedBeds: 54, occupancyRate: 58.3 },
      { name: "UC Davis Medical Center", county: "Sacramento", type: "General Acute", ownership: "Non-Profit", mediCalPct: 18.9, medicarePct: 31.2, commercialPct: 40.1, otherPct: 9.8, operatingMargin: 5.6, equityBurdenScore: 22, riskProbability: 0.14, licensedBeds: 627, occupancyRate: 85.7 },
      { name: "Mercy General Hospital", county: "Sacramento", type: "General Acute", ownership: "Non-Profit", mediCalPct: 28.4, medicarePct: 34.7, commercialPct: 29.3, otherPct: 7.6, operatingMargin: 2.1, equityBurdenScore: 35, riskProbability: 0.29, licensedBeds: 342, occupancyRate: 72.4 },
      { name: "Sutter Medical Center", county: "Sacramento", type: "General Acute", ownership: "Non-Profit", mediCalPct: 15.3, medicarePct: 33.5, commercialPct: 42.8, otherPct: 8.4, operatingMargin: 7.3, equityBurdenScore: 19, riskProbability: 0.12, licensedBeds: 523, occupancyRate: 76.9 },
      { name: "UC San Diego Health", county: "San Diego", type: "General Acute", ownership: "Non-Profit", mediCalPct: 14.7, medicarePct: 28.3, commercialPct: 47.9, otherPct: 9.1, operatingMargin: 9.2, equityBurdenScore: 16, riskProbability: 0.09, licensedBeds: 808, occupancyRate: 84.2 },
      { name: "Sharp Memorial Hospital", county: "San Diego", type: "General Acute", ownership: "Non-Profit", mediCalPct: 19.8, medicarePct: 35.2, commercialPct: 36.4, otherPct: 8.6, operatingMargin: 4.8, equityBurdenScore: 24, riskProbability: 0.18, licensedBeds: 457, occupancyRate: 79.5 },
      { name: "Scripps Mercy Hospital", county: "San Diego", type: "General Acute", ownership: "Non-Profit", mediCalPct: 32.1, medicarePct: 31.8, commercialPct: 28.5, otherPct: 7.6, operatingMargin: 1.4, equityBurdenScore: 38, riskProbability: 0.34, licensedBeds: 511, occupancyRate: 74.1 },
      { name: "El Centro Regional Medical Center", county: "San Diego", type: "General Acute", ownership: "District", mediCalPct: 58.9, medicarePct: 24.6, commercialPct: 9.8, otherPct: 6.7, operatingMargin: -9.1, equityBurdenScore: 78, riskProbability: 0.74, licensedBeds: 161, occupancyRate: 92.3 },
    ];

    /* ── Utilities ── */

    function riskTier(p) {
      if (p >= 0.65) return 'high';
      if (p >= 0.35) return 'medium';
      return 'low';
    }

    function riskColor(tier) {
      return { low: 'var(--risk-low)', medium: 'var(--risk-med)', high: 'var(--risk-high)' }[tier];
    }

    function fmt(n, decimals = 1) {
      return n.toFixed(decimals);
    }

    function pct(n) {
      return fmt(n) + '%';
    }

    function matchName(hospital, query) {
      return hospital.name.toLowerCase().includes(query.toLowerCase());
    }

    function filterData({ county, risk, search } = {}) {
      return HOSPITALS.filter(h => {
        if (county && h.county !== county) return false;
        if (risk && riskTier(h.riskProbability) !== risk) return false;
        if (search && !matchName(h, search)) return false;
        return true;
      });
    }

    /* ── Rendering ── */

    const display = document.getElementById('display');

    function renderTable(hospitals, label) {
      const summary = label || `${hospitals.length} hospitals`;
      display.innerHTML = `
        <div class="summary-row">
          <p class="view-label">Showing ${summary}</p>
          <span class="summary-count">${hospitals.length} result${hospitals.length !== 1 ? 's' : ''}</span>
        </div>
        <table class="hospital-table">
          <thead>
            <tr>
              <th>Hospital</th>
              <th>County</th>
              <th>Risk</th>
              <th>Medi-Cal</th>
              <th>Equity Burden</th>
              <th>Margin</th>
            </tr>
          </thead>
          <tbody>
            ${hospitals.map(h => `
              <tr tabindex="0" data-name="${h.name}" onclick="showDetail('${h.name.replace(/'/g, "\\'")}')" onkeydown="if(event.key==='Enter')showDetail('${h.name.replace(/'/g, "\\'")}')">
                <td>${h.name}</td>
                <td>${h.county}</td>
                <td><span class="risk-badge ${riskTier(h.riskProbability)}">${riskTier(h.riskProbability)}</span></td>
                <td>${pct(h.mediCalPct)}</td>
                <td>${h.equityBurdenScore}</td>
                <td style="color: ${h.operatingMargin < 0 ? 'var(--risk-high)' : 'var(--risk-low)'}">${fmt(h.operatingMargin)}%</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderChart(hospitals, label) {
      const tiers = { low: 0, medium: 0, high: 0 };
      hospitals.forEach(h => tiers[riskTier(h.riskProbability)]++);
      const max = Math.max(tiers.low, tiers.medium, tiers.high, 1);
      const title = label || 'all hospitals';

      display.innerHTML = `
        <p class="view-label">Risk distribution across ${title} (${hospitals.length} total)</p>
        <div class="chart-container">
          <div class="chart-row">
            <span class="chart-label" style="color: var(--risk-low)">Low</span>
            <div class="chart-bar-track">
              <div class="chart-bar-fill" style="width: ${(tiers.low / max) * 100}%; background: var(--risk-low);"></div>
            </div>
            <span class="chart-value">${tiers.low}</span>
          </div>
          <div class="chart-row">
            <span class="chart-label" style="color: var(--risk-med)">Medium</span>
            <div class="chart-bar-track">
              <div class="chart-bar-fill" style="width: ${(tiers.medium / max) * 100}%; background: var(--risk-med);"></div>
            </div>
            <span class="chart-value">${tiers.medium}</span>
          </div>
          <div class="chart-row">
            <span class="chart-label" style="color: var(--risk-high)">High</span>
            <div class="chart-bar-track">
              <div class="chart-bar-fill" style="width: ${(tiers.high / max) * 100}%; background: var(--risk-high);"></div>
            </div>
            <span class="chart-value">${tiers.high}</span>
          </div>
        </div>
      `;
    }

    function renderDetail(hospital) {
      const h = hospital;
      const tier = riskTier(h.riskProbability);

      display.innerHTML = `
        <button class="back-btn" onclick="renderTable(HOSPITALS)">&#8592; Back to list</button>
        <div class="detail-card">
          <div class="detail-header">
            <h2>${h.name}</h2>
            <p class="detail-meta">${h.county} &middot; ${h.type} &middot; ${h.ownership} &middot; <span class="risk-badge ${tier}">${tier} risk</span></p>
          </div>
          <div class="detail-grid">
            <div class="detail-cell">
              <div class="detail-cell-label">Risk Probability</div>
              <div class="detail-cell-value" style="color: ${riskColor(tier)}">${pct(h.riskProbability * 100)}</div>
            </div>
            <div class="detail-cell">
              <div class="detail-cell-label">Equity Burden</div>
              <div class="detail-cell-value">${h.equityBurdenScore}<span style="font-size:14px;color:var(--text-muted)"> / 100</span></div>
            </div>
            <div class="detail-cell">
              <div class="detail-cell-label">Operating Margin</div>
              <div class="detail-cell-value" style="color: ${h.operatingMargin < 0 ? 'var(--risk-high)' : 'var(--risk-low)'}">${fmt(h.operatingMargin)}%</div>
            </div>
            <div class="detail-cell">
              <div class="detail-cell-label">Occupancy Rate</div>
              <div class="detail-cell-value">${pct(h.occupancyRate)}</div>
            </div>
            <div class="detail-cell">
              <div class="detail-cell-label">Licensed Beds</div>
              <div class="detail-cell-value">${h.licensedBeds}</div>
            </div>
            <div class="detail-cell">
              <div class="detail-cell-label">Medi-Cal Share</div>
              <div class="detail-cell-value" style="color: ${h.mediCalPct > 40 ? 'var(--risk-high)' : 'var(--text)'}">${pct(h.mediCalPct)}</div>
            </div>
          </div>
          <div style="padding: 16px 24px;">
            <div class="detail-cell-label" style="margin-bottom: 8px;">Payer Mix</div>
            <div class="payer-bar">
              <div class="payer-segment-medicaid" style="width: ${h.mediCalPct}%"></div>
              <div class="payer-segment-medicare" style="width: ${h.medicarePct}%"></div>
              <div class="payer-segment-commercial" style="width: ${h.commercialPct}%"></div>
              <div class="payer-segment-other" style="width: ${h.otherPct}%"></div>
            </div>
          </div>
          <div class="payer-legend">
            <span class="payer-legend-item"><span class="payer-legend-dot" style="background:var(--risk-high)"></span> Medi-Cal ${pct(h.mediCalPct)}</span>
            <span class="payer-legend-item"><span class="payer-legend-dot" style="background:var(--risk-med)"></span> Medicare ${pct(h.medicarePct)}</span>
            <span class="payer-legend-item"><span class="payer-legend-dot" style="background:var(--risk-low)"></span> Commercial ${pct(h.commercialPct)}</span>
            <span class="payer-legend-item"><span class="payer-legend-dot" style="background:#8b5cf6"></span> Other ${pct(h.otherPct)}</span>
          </div>
        </div>
      `;
    }

    /* ── Global detail handler (called from table rows) ── */

    function showDetail(name) {
      const h = HOSPITALS.find(h => h.name === name);
      if (h) renderDetail(h);
    }

    /* ── Shared tool definitions ── */

    const TOOL_DEFS = [
      {
        name: 'filter_hospitals',
        description: 'Filter and display California hospitals on the page. Renders a table showing matching hospitals with risk tier, Medi-Cal share, equity burden score, and operating margin. The user can then click any row to see full details.',
        schema: {
          type: 'object',
          properties: {
            county: { type: 'string', enum: ['Los Angeles', 'San Francisco', 'Sacramento', 'San Diego'], description: 'Filter by county' },
            risk: { type: 'string', enum: ['low', 'medium', 'high'], description: 'Filter by ML-predicted risk tier' },
            search: { type: 'string', description: 'Search hospital name (partial match)' }
          }
        },
        exec: async (input) => {
          const filtered = filterData(input);
          const parts = [];
          if (input.county) parts.push(`in ${input.county}`);
          if (input.risk) parts.push(`${input.risk} risk`);
          if (input.search) parts.push(`matching "${input.search}"`);
          const label = parts.length ? parts.join(', ') : 'all hospitals';
          renderTable(filtered, label);
          return { displayed: true, count: filtered.length, summary: `Rendered ${filtered.length} hospitals (${label}). User can now see the table and click any row for details.` };
        }
      },
      {
        name: 'show_risk_chart',
        description: 'Display a visual bar chart showing the distribution of hospital financial risk tiers (low/medium/high). Renders directly on the page so the user can see the breakdown visually.',
        schema: {
          type: 'object',
          properties: {
            county: { type: 'string', enum: ['Los Angeles', 'San Francisco', 'Sacramento', 'San Diego'], description: 'Limit chart to a specific county' }
          }
        },
        exec: async (input) => {
          const hospitals = input.county ? filterData({ county: input.county }) : HOSPITALS;
          const label = input.county || 'all hospitals';
          renderChart(hospitals, label);
          const tiers = { low: 0, medium: 0, high: 0 };
          hospitals.forEach(h => tiers[riskTier(h.riskProbability)]++);
          return { displayed: true, summary: `Chart displayed: ${tiers.low} low, ${tiers.medium} medium, ${tiers.high} high risk (${label}).`, distribution: tiers };
        }
      },
      {
        name: 'show_hospital_detail',
        description: 'Display a detailed profile card for a specific hospital, showing risk probability, equity burden score, operating margin, payer mix breakdown, occupancy, and bed count. Renders visually on the page.',
        schema: {
          type: 'object',
          properties: {
            name: { type: 'string', description: 'Hospital name (partial match supported)' }
          },
          required: ['name']
        },
        exec: async (input) => {
          const hospital = HOSPITALS.find(h => matchName(h, input.name));
          if (!hospital) return { displayed: false, summary: `No hospital found matching "${input.name}".` };
          renderDetail(hospital);
          const tier = riskTier(hospital.riskProbability);
          return { displayed: true, summary: `Showing ${hospital.name} — ${tier} risk, equity burden ${hospital.equityBurdenScore}/100, margin ${fmt(hospital.operatingMargin)}%.` };
        }
      }
    ];

    /* ── Button controls (mirror tool functionality) ── */

    document.querySelectorAll('.chip[data-filter]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');

        const filter = btn.dataset.filter;
        if (filter === 'all') {
          renderTable(HOSPITALS);
        } else if (filter === 'high') {
          const filtered = filterData({ risk: 'high' });
          renderTable(filtered, 'high-risk hospitals');
        } else {
          const filtered = filterData({ county: filter });
          renderTable(filtered, `hospitals in ${filter}`);
        }
      });
    });

    document.querySelector('.chip[data-view="chart"]').addEventListener('click', () => {
      document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
      document.querySelector('.chip[data-view="chart"]').classList.add('active');
      renderChart(HOSPITALS);
    });

    /* ── WebMCP registration ── */

    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');

    function registerTools() {
      if (!('modelContext' in navigator)) {
        statusText.textContent = 'WebMCP not detected';
        return;
      }

      statusDot.classList.add('active');
      statusText.textContent = 'WebMCP active';

      navigator.modelContext.provideContext({
        tools: TOOL_DEFS.map(t => ({
          name: t.name,
          description: t.description,
          inputSchema: t.schema,
          annotations: { readOnlyHint: true },
          execute: t.exec
        }))
      });
    }

    /* ── Chat panel ── */

    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');
    const apiKeyInput = document.getElementById('api-key');
    const keyToggle = document.getElementById('key-toggle');

    const SYSTEM_PROMPT = `You are embedded in a WebMCP proof-of-concept that explores California hospital financial data. Your tools render visuals (tables, charts, detail cards) directly on the page — the user already sees the full result. You only receive a brief summary.

Rules:
- 1-2 sentences max after a tool call. Never redescribe what the visualization already shows.
- Call tools eagerly. If the user asks to see data, call the tool — don't narrate what you're about to do.
- End with a short follow-up suggestion (one line) so the user knows what else they can explore.
- No markdown formatting — this renders as plain text in a chat bubble.
- No greetings, filler, or preamble.`;
    const CLAUDE_TOOLS = TOOL_DEFS.map(t => ({ name: t.name, description: t.description, input_schema: t.schema }));

    let conversationMessages = [];
    let chatBusy = false;

    // Restore API key from sessionStorage
    apiKeyInput.value = sessionStorage.getItem('webmcp-api-key') || '';
    apiKeyInput.addEventListener('input', () => sessionStorage.setItem('webmcp-api-key', apiKeyInput.value));

    keyToggle.addEventListener('click', () => {
      const hidden = apiKeyInput.type === 'password';
      apiKeyInput.type = hidden ? 'text' : 'password';
      keyToggle.textContent = hidden ? 'Hide' : 'Show';
    });

    // Auto-resize textarea
    chatInput.addEventListener('input', () => {
      chatInput.style.height = 'auto';
      chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
    });

    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    chatSend.addEventListener('click', sendMessage);

    function appendMessage(type, content) {
      // Clear empty state
      const empty = chatMessages.querySelector('.chat-empty');
      if (empty) empty.remove();

      const el = document.createElement('div');
      el.className = `msg msg-${type}`;
      el.textContent = content;
      chatMessages.appendChild(el);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return el;
    }

    function appendToolMsg(toolName, args, result) {
      const empty = chatMessages.querySelector('.chat-empty');
      if (empty) empty.remove();

      const el = document.createElement('div');
      el.className = 'msg msg-tool';
      el.innerHTML = `<span class="msg-tool-name">${toolName}</span>(${JSON.stringify(args)})\n<span class="msg-tool-result">&rarr; ${result}</span>`;
      chatMessages.appendChild(el);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showSpinner() {
      const el = document.createElement('div');
      el.className = 'chat-spinner';
      el.id = 'chat-spinner';
      chatMessages.appendChild(el);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideSpinner() {
      const s = document.getElementById('chat-spinner');
      if (s) s.remove();
    }

    function setInputEnabled(enabled) {
      chatBusy = !enabled;
      chatSend.disabled = !enabled;
      chatInput.disabled = !enabled;
    }

    async function sendMessage() {
      const text = chatInput.value.trim();
      const apiKey = apiKeyInput.value.trim();
      if (!text || chatBusy) return;

      if (!apiKey) {
        appendMessage('error', 'Enter your Anthropic API key above.');
        return;
      }

      appendMessage('user', text);
      chatInput.value = '';
      chatInput.style.height = 'auto';

      conversationMessages.push({ role: 'user', content: text });
      setInputEnabled(false);
      showSpinner();

      await runConversation(apiKey);

      hideSpinner();
      setInputEnabled(true);
      chatInput.focus();
    }

    async function runConversation(apiKey) {
      while (true) {
        let response;
        try {
          response = await callClaudeAPI(apiKey, conversationMessages);
        } catch (err) {
          hideSpinner();
          appendMessage('error', err.message);
          return;
        }

        conversationMessages.push({ role: 'assistant', content: response.content });

        // Collect text blocks
        const textParts = response.content
          .filter(b => b.type === 'text')
          .map(b => b.text)
          .join('\n');

        // Collect tool_use blocks
        const toolUses = response.content.filter(b => b.type === 'tool_use');

        if (toolUses.length === 0) {
          hideSpinner();
          if (textParts) appendMessage('assistant', textParts);
          return;
        }

        // Show any text before tool calls
        if (textParts) appendMessage('assistant', textParts);

        // Execute tools and gather results
        const toolResults = [];
        for (const tu of toolUses) {
          const def = TOOL_DEFS.find(t => t.name === tu.name);
          let result;
          if (def) {
            result = await def.exec(tu.input);
            appendToolMsg(tu.name, tu.input, result.summary);
          } else {
            result = { error: `Unknown tool: ${tu.name}` };
          }
          toolResults.push({
            type: 'tool_result',
            tool_use_id: tu.id,
            content: JSON.stringify(result)
          });
        }

        conversationMessages.push({ role: 'user', content: toolResults });
        // Loop to send tool results back
      }
    }

    async function callClaudeAPI(apiKey, messages) {
      const res = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-haiku-4-5-20251001',
          max_tokens: 1024,
          system: SYSTEM_PROMPT,
          messages,
          tools: CLAUDE_TOOLS
        })
      });

      if (!res.ok) {
        const body = await res.text();
        throw new Error(`API ${res.status}: ${body.slice(0, 200)}`);
      }

      return res.json();
    }

    /* ── Init ── */

    renderTable(HOSPITALS);
    registerTools();
  </script>
</body>
</html>
