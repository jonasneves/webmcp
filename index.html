<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0f172a">
  <title>WebMCP PoC — Hospital Explorer</title>
  <script>
    // Remove native navigator.modelContext so @mcp-b/global polyfill
    // can install its own version with MCP bridge support
    if ('modelContext' in navigator) {
      delete navigator.modelContext;
      // If non-configurable, override via defineProperty
      if ('modelContext' in navigator) {
        Object.defineProperty(navigator, 'modelContext', {
          value: undefined,
          writable: true,
          configurable: true
        });
      }
    }
  </script>
  <script src="https://unpkg.com/@mcp-b/global@latest/dist/index.iife.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --surface: #1e293b;
      --surface-alt: #334155;
      --border: #475569;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --accent: #38bdf8;
      --accent-dim: #0c4a6e;
      --risk-low: #22c55e;
      --risk-med: #f59e0b;
      --risk-high: #ef4444;
      --flag: #f59e0b;
      --radius: 8px;
      --radius-lg: 12px;
      --font: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --mono: ui-monospace, 'SF Mono', SFMono-Regular, Menlo, monospace;
      --transition: 150ms ease;
    }

    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; animation: none !important; }
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100dvh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
    }

    header h1 {
      font-size: 18px;
      font-weight: 600;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-muted);
      padding: 6px 12px;
      background: var(--surface);
      border-radius: 100px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
    }

    .status-dot.active { background: var(--risk-low); }

    .layout {
      display: grid;
      grid-template-columns: 1fr 380px;
      min-height: calc(100dvh - 57px);
    }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .chat-panel { border-left: none; border-top: 1px solid var(--border); max-height: 50dvh; }
    }

    main { padding: 24px; overflow-y: auto; }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 24px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      min-height: 44px;
      padding: 0 16px;
      font-size: 14px;
      font-family: var(--font);
      color: var(--text-muted);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 100px;
      cursor: pointer;
      transition: background var(--transition), color var(--transition), border-color var(--transition);
    }

    .chip:hover { background: var(--surface-alt); color: var(--text); }
    .chip:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .chip.active { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }

    .chip-separator {
      width: 1px;
      height: 28px;
      background: var(--border);
      align-self: center;
    }

    #display { min-height: 200px; }

    /* Loading skeleton */
    @keyframes shimmer {
      0% { background-position: -400px 0; }
      100% { background-position: 400px 0; }
    }

    .loading-skeleton {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .skeleton-row {
      height: 44px;
      border-radius: var(--radius);
      background: linear-gradient(90deg, var(--surface) 25%, var(--surface-alt) 50%, var(--surface) 75%);
      background-size: 800px 44px;
      animation: shimmer 1.5s infinite linear;
    }

    /* Table view */
    .hospital-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .hospital-table th {
      text-align: left;
      padding: 10px 12px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }

    .hospital-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--surface-alt);
      white-space: nowrap;
    }

    .hospital-table tbody tr {
      cursor: pointer;
      transition: background var(--transition);
    }

    .hospital-table tbody tr:hover { background: var(--surface); }
    .hospital-table tbody tr:focus-visible { outline: 2px solid var(--accent); outline-offset: -2px; }

    .hospital-name-cell {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .risk-badge {
      display: inline-block;
      padding: 2px 10px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 100px;
      letter-spacing: 0.04em;
    }

    .risk-badge.low { background: #052e16; color: var(--risk-low); }
    .risk-badge.medium { background: #451a03; color: var(--risk-med); }
    .risk-badge.high { background: #450a0a; color: var(--risk-high); }

    /* Flag dot */
    .flag-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--flag);
      flex-shrink: 0;
    }

    .flag-note {
      padding: 8px 24px 0;
      font-size: 13px;
      color: var(--flag);
      font-style: italic;
    }

    /* Chart view */
    .chart-container { max-width: 600px; }

    .chart-row {
      display: grid;
      grid-template-columns: 80px 1fr 50px;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .chart-label {
      font-size: 14px;
      font-weight: 500;
      text-align: right;
    }

    .chart-bar-track {
      height: 32px;
      background: var(--surface);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .chart-bar-fill {
      height: 100%;
      border-radius: var(--radius);
      transition: width 400ms ease;
    }

    .chart-value {
      font-size: 14px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    /* Comparison view */
    .compare-table {
      width: 100%;
      max-width: 640px;
      border-collapse: collapse;
      font-size: 14px;
    }

    .compare-table th {
      text-align: left;
      padding: 10px 16px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
    }

    .compare-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--surface-alt);
    }

    .compare-metric {
      color: var(--text-muted);
      font-size: 13px;
    }

    .compare-value {
      font-variant-numeric: tabular-nums;
      font-weight: 500;
    }

    .compare-better {
      color: var(--risk-low);
      font-weight: 700;
    }

    /* Detail view */
    .detail-card {
      max-width: 640px;
      background: var(--surface);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .detail-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--surface-alt);
    }

    .detail-header h2 {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .detail-meta {
      font-size: 13px;
      color: var(--text-muted);
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: var(--surface-alt);
    }

    .detail-cell {
      padding: 16px 24px;
      background: var(--surface);
    }

    .detail-cell-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .detail-cell-value {
      font-size: 18px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .payer-bar {
      display: flex;
      height: 12px;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 8px;
    }

    .payer-bar > div { transition: width 400ms ease; }
    .payer-segment-medicaid { background: var(--risk-high); }
    .payer-segment-medicare { background: var(--risk-med); }
    .payer-segment-commercial { background: var(--risk-low); }
    .payer-segment-other { background: #8b5cf6; }

    .payer-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      padding: 16px 24px;
      font-size: 13px;
      color: var(--text-muted);
      border-top: 1px solid var(--surface-alt);
    }

    .payer-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .payer-legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .view-label {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      min-height: 44px;
      padding: 0 16px;
      font-size: 13px;
      font-family: var(--font);
      color: var(--accent);
      background: none;
      border: 1px solid var(--accent-dim);
      border-radius: var(--radius);
      cursor: pointer;
      margin-bottom: 16px;
    }

    .back-btn:hover { background: var(--accent-dim); }
    .back-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    /* Chat panel */
    .chat-panel {
      border-left: 1px solid var(--border);
      background: var(--surface);
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-muted);
      border-bottom: 1px solid var(--surface-alt);
    }

    .chat-reset {
      min-width: 44px;
      min-height: 32px;
      padding: 0 12px;
      font-size: 11px;
      font-weight: 600;
      font-family: var(--font);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-muted);
      background: none;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: color var(--transition), border-color var(--transition);
    }

    .chat-reset:hover { color: var(--text); border-color: var(--text-muted); }
    .chat-reset:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    .api-key-bar {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--surface-alt);
    }

    .api-key-bar input {
      flex: 1;
      min-height: 36px;
      padding: 0 12px;
      font-size: 13px;
      font-family: var(--mono);
      color: var(--text);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }

    .api-key-bar input::placeholder { color: var(--text-muted); }
    .api-key-bar input:focus { outline: 2px solid var(--accent); outline-offset: -1px; }

    .api-key-toggle {
      min-width: 44px;
      min-height: 36px;
      font-size: 13px;
      font-family: var(--font);
      color: var(--text-muted);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
    }

    .api-key-toggle:hover { color: var(--text); }
    .api-key-toggle:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .chat-empty {
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
      padding: 24px 16px;
      line-height: 1.6;
    }

    .msg {
      max-width: 90%;
      padding: 10px 14px;
      border-radius: var(--radius-lg);
      font-size: 13px;
      line-height: 1.5;
      word-break: break-word;
    }

    .msg-user {
      align-self: flex-end;
      background: var(--accent-dim);
      color: var(--accent);
      border-bottom-right-radius: 4px;
    }

    .msg-assistant {
      align-self: flex-start;
      background: var(--surface-alt);
      color: var(--text);
      border-bottom-left-radius: 4px;
    }

    .msg-tool {
      align-self: flex-start;
      max-width: 95%;
      padding: 8px 12px;
      font-family: var(--mono);
      font-size: 11px;
      line-height: 1.6;
      color: var(--text-muted);
      background: var(--bg);
      border: 1px solid var(--surface-alt);
      border-radius: var(--radius);
    }

    .msg-tool-name { color: var(--accent); font-weight: 600; }
    .msg-tool-result { color: var(--risk-low); }

    .msg-context {
      align-self: center;
      padding: 6px 16px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-muted);
      background: none;
      border: 1px dashed var(--border);
      border-radius: 100px;
    }

    .msg-error {
      align-self: center;
      padding: 8px 14px;
      font-size: 12px;
      color: var(--risk-high);
      background: #450a0a;
      border-radius: var(--radius);
    }

    .chat-input-area {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-top: 1px solid var(--surface-alt);
    }

    .chat-input-area textarea {
      flex: 1;
      min-height: 44px;
      max-height: 120px;
      padding: 10px 12px;
      font-size: 14px;
      font-family: var(--font);
      color: var(--text);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      resize: none;
      line-height: 1.4;
    }

    .chat-input-area textarea::placeholder { color: var(--text-muted); }
    .chat-input-area textarea:focus { outline: 2px solid var(--accent); outline-offset: -1px; }

    .chat-send {
      min-width: 44px;
      min-height: 44px;
      font-size: 18px;
      font-family: var(--font);
      color: var(--bg);
      background: var(--accent);
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: opacity var(--transition);
    }

    .chat-send:disabled { opacity: 0.4; cursor: default; }
    .chat-send:not(:disabled):hover { opacity: 0.85; }
    .chat-send:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    @keyframes chat-spin {
      to { transform: rotate(360deg); }
    }

    .chat-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--surface-alt);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: chat-spin 0.6s linear infinite;
      align-self: flex-start;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }

    .summary-count {
      font-size: 13px;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <header>
    <h1>WebMCP PoC</h1>
    <div class="status-badge">
      <span class="status-dot" id="status-dot"></span>
      <span id="status-text">Checking...</span>
    </div>
  </header>

  <div class="layout">
    <main>
      <nav class="controls" aria-label="Filters">
        <button class="chip active" data-filter="all">All</button>
        <button class="chip" data-filter="Los Angeles">Los Angeles</button>
        <button class="chip" data-filter="San Francisco">San Francisco</button>
        <button class="chip" data-filter="Sacramento">Sacramento</button>
        <button class="chip" data-filter="San Diego">San Diego</button>
        <div class="chip-separator"></div>
        <button class="chip" data-view="chart">Risk Overview</button>
        <button class="chip" data-filter="high">High Risk Only</button>
      </nav>

      <div id="display"></div>
    </main>

    <aside class="chat-panel">
      <div class="chat-header">
        <span>Chat</span>
        <button class="chat-reset" id="chat-reset">Clear</button>
      </div>
      <div class="api-key-bar">
        <input type="password" id="api-key" placeholder="sk-ant-..." autocomplete="off" spellcheck="false" aria-label="Anthropic API key">
        <button class="api-key-toggle" id="key-toggle" aria-label="Toggle key visibility">Show</button>
      </div>
      <div class="chat-messages" id="chat-messages">
        <div class="chat-empty">Ask a question about California hospital data.</div>
      </div>
      <div class="chat-input-area">
        <textarea id="chat-input" placeholder="Ask about hospitals..." rows="1" aria-label="Chat message"></textarea>
        <button class="chat-send" id="chat-send" aria-label="Send message">&uarr;</button>
      </div>
    </aside>
  </div>

  <script>
    /* ── Dataset ── */

    let HOSPITALS = [];

    /* ── State ── */

    const flaggedHospitals = new Map();
    let currentView = { type: 'table', data: null, label: null };

    /* ── Utilities ── */

    function riskTier(p) {
      if (p >= 0.65) return 'high';
      if (p >= 0.35) return 'medium';
      return 'low';
    }

    function riskColor(tier) {
      return { low: 'var(--risk-low)', medium: 'var(--risk-med)', high: 'var(--risk-high)' }[tier];
    }

    function fmt(n, decimals = 1) {
      return n.toFixed(decimals);
    }

    function pct(n) {
      return fmt(n) + '%';
    }

    function matchName(hospital, query) {
      return hospital.name.toLowerCase().includes(query.toLowerCase());
    }

    function filterData({ county, risk, search } = {}) {
      return HOSPITALS.filter(h => {
        if (county && h.county !== county) return false;
        if (risk && riskTier(h.riskProbability) !== risk) return false;
        if (search && !matchName(h, search)) return false;
        return true;
      });
    }

    function scrollDisplayIntoView() {
      if (window.matchMedia('(max-width: 900px)').matches) {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } else {
        display.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    function refreshCurrentView() {
      if (currentView.type === 'table') {
        renderTable(currentView.data || HOSPITALS, currentView.label);
      } else if (currentView.type === 'chart') {
        renderChart(currentView.data || HOSPITALS, currentView.label);
      } else if (currentView.type === 'detail' && currentView.data) {
        renderDetail(currentView.data);
      } else if (currentView.type === 'comparison' && currentView.data) {
        renderComparison(currentView.data[0], currentView.data[1]);
      }
    }

    /* ── Rendering ── */

    const display = document.getElementById('display');

    function renderSkeleton() {
      display.innerHTML = `
        <div class="loading-skeleton">
          ${Array.from({ length: 8 }, (_, i) =>
            `<div class="skeleton-row" style="animation-delay: ${i * 80}ms"></div>`
          ).join('')}
        </div>
      `;
    }

    function renderTable(hospitals, label) {
      currentView = { type: 'table', data: hospitals, label };
      const summary = label || `${hospitals.length} hospitals`;
      display.innerHTML = `
        <div class="summary-row">
          <p class="view-label">Showing ${summary}</p>
          <span class="summary-count">${hospitals.length} result${hospitals.length !== 1 ? 's' : ''}</span>
        </div>
        <table class="hospital-table">
          <thead>
            <tr>
              <th>Hospital</th>
              <th>County</th>
              <th>Risk</th>
              <th>Medi-Cal</th>
              <th>Equity Burden</th>
              <th>Margin</th>
            </tr>
          </thead>
          <tbody>
            ${hospitals.map(h => {
              const isFlagged = flaggedHospitals.has(h.name);
              return `
              <tr tabindex="0" data-name="${h.name}" onclick="showDetail('${h.name.replace(/'/g, "\\'")}')" onkeydown="if(event.key==='Enter')showDetail('${h.name.replace(/'/g, "\\'")}')">
                <td><span class="hospital-name-cell">${isFlagged ? '<span class="flag-dot" title="Flagged"></span>' : ''}${h.name}</span></td>
                <td>${h.county}</td>
                <td><span class="risk-badge ${riskTier(h.riskProbability)}">${riskTier(h.riskProbability)}</span></td>
                <td>${pct(h.mediCalPct)}</td>
                <td>${h.equityBurdenScore}</td>
                <td style="color: ${h.operatingMargin < 0 ? 'var(--risk-high)' : 'var(--risk-low)'}">${fmt(h.operatingMargin)}%</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    function renderChart(hospitals, label) {
      currentView = { type: 'chart', data: hospitals, label };
      const tiers = { low: 0, medium: 0, high: 0 };
      hospitals.forEach(h => tiers[riskTier(h.riskProbability)]++);
      const max = Math.max(tiers.low, tiers.medium, tiers.high, 1);
      const title = label || 'all hospitals';

      display.innerHTML = `
        <p class="view-label">Risk distribution across ${title} (${hospitals.length} total)</p>
        <div class="chart-container">
          <div class="chart-row">
            <span class="chart-label" style="color: var(--risk-low)">Low</span>
            <div class="chart-bar-track">
              <div class="chart-bar-fill" style="width: ${(tiers.low / max) * 100}%; background: var(--risk-low);"></div>
            </div>
            <span class="chart-value">${tiers.low}</span>
          </div>
          <div class="chart-row">
            <span class="chart-label" style="color: var(--risk-med)">Medium</span>
            <div class="chart-bar-track">
              <div class="chart-bar-fill" style="width: ${(tiers.medium / max) * 100}%; background: var(--risk-med);"></div>
            </div>
            <span class="chart-value">${tiers.medium}</span>
          </div>
          <div class="chart-row">
            <span class="chart-label" style="color: var(--risk-high)">High</span>
            <div class="chart-bar-track">
              <div class="chart-bar-fill" style="width: ${(tiers.high / max) * 100}%; background: var(--risk-high);"></div>
            </div>
            <span class="chart-value">${tiers.high}</span>
          </div>
        </div>
      `;
    }

    function renderDetail(hospital) {
      const h = hospital;
      const tier = riskTier(h.riskProbability);
      const flag = flaggedHospitals.get(h.name);
      currentView = { type: 'detail', data: h, label: null };

      display.innerHTML = `
        <button class="back-btn" onclick="renderTable(HOSPITALS)">&#8592; Back to list</button>
        <div class="detail-card">
          <div class="detail-header">
            <h2>${flag ? '<span class="flag-dot"></span>' : ''}${h.name}</h2>
            <p class="detail-meta">${h.county} &middot; ${h.type} &middot; ${h.ownership} &middot; <span class="risk-badge ${tier}">${tier} risk</span></p>
          </div>
          ${flag ? `<p class="flag-note">${flag.note}</p>` : ''}
          <div class="detail-grid">
            <div class="detail-cell">
              <div class="detail-cell-label">Risk Probability</div>
              <div class="detail-cell-value" style="color: ${riskColor(tier)}">${pct(h.riskProbability * 100)}</div>
            </div>
            <div class="detail-cell">
              <div class="detail-cell-label">Equity Burden</div>
              <div class="detail-cell-value">${h.equityBurdenScore}<span style="font-size:14px;color:var(--text-muted)"> / 100</span></div>
            </div>
            <div class="detail-cell">
              <div class="detail-cell-label">Operating Margin</div>
              <div class="detail-cell-value" style="color: ${h.operatingMargin < 0 ? 'var(--risk-high)' : 'var(--risk-low)'}">${fmt(h.operatingMargin)}%</div>
            </div>
            <div class="detail-cell">
              <div class="detail-cell-label">Occupancy Rate</div>
              <div class="detail-cell-value">${pct(h.occupancyRate)}</div>
            </div>
            <div class="detail-cell">
              <div class="detail-cell-label">Licensed Beds</div>
              <div class="detail-cell-value">${h.licensedBeds}</div>
            </div>
            <div class="detail-cell">
              <div class="detail-cell-label">Medi-Cal Share</div>
              <div class="detail-cell-value" style="color: ${h.mediCalPct > 40 ? 'var(--risk-high)' : 'var(--text)'}">${pct(h.mediCalPct)}</div>
            </div>
          </div>
          <div style="padding: 16px 24px;">
            <div class="detail-cell-label" style="margin-bottom: 8px;">Payer Mix</div>
            <div class="payer-bar">
              <div class="payer-segment-medicaid" style="width: ${h.mediCalPct}%"></div>
              <div class="payer-segment-medicare" style="width: ${h.medicarePct}%"></div>
              <div class="payer-segment-commercial" style="width: ${h.commercialPct}%"></div>
              <div class="payer-segment-other" style="width: ${h.otherPct}%"></div>
            </div>
          </div>
          <div class="payer-legend">
            <span class="payer-legend-item"><span class="payer-legend-dot" style="background:var(--risk-high)"></span> Medi-Cal ${pct(h.mediCalPct)}</span>
            <span class="payer-legend-item"><span class="payer-legend-dot" style="background:var(--risk-med)"></span> Medicare ${pct(h.medicarePct)}</span>
            <span class="payer-legend-item"><span class="payer-legend-dot" style="background:var(--risk-low)"></span> Commercial ${pct(h.commercialPct)}</span>
            <span class="payer-legend-item"><span class="payer-legend-dot" style="background:#8b5cf6"></span> Other ${pct(h.otherPct)}</span>
          </div>
        </div>
      `;
    }

    function renderComparison(h1, h2) {
      currentView = { type: 'comparison', data: [h1, h2], label: null };

      const metrics = [
        { label: 'Risk Probability', key: 'riskProbability', format: v => pct(v * 100), lowerBetter: true },
        { label: 'Equity Burden', key: 'equityBurdenScore', format: v => `${v} / 100`, lowerBetter: true },
        { label: 'Operating Margin', key: 'operatingMargin', format: v => `${fmt(v)}%`, lowerBetter: false },
        { label: 'Medi-Cal Share', key: 'mediCalPct', format: v => pct(v), lowerBetter: true },
        { label: 'Occupancy Rate', key: 'occupancyRate', format: v => pct(v), lowerBetter: false },
        { label: 'Licensed Beds', key: 'licensedBeds', format: v => v, lowerBetter: false },
      ];

      function betterClass(v1, v2, lowerBetter) {
        if (v1 === v2) return ['', ''];
        const v1Wins = lowerBetter ? v1 < v2 : v1 > v2;
        return v1Wins ? ['compare-better', ''] : ['', 'compare-better'];
      }

      display.innerHTML = `
        <button class="back-btn" onclick="renderTable(HOSPITALS)">&#8592; Back to list</button>
        <p class="view-label">Comparing two hospitals</p>
        <table class="compare-table">
          <thead>
            <tr>
              <th>Metric</th>
              <th>${h1.name}</th>
              <th>${h2.name}</th>
            </tr>
          </thead>
          <tbody>
            ${metrics.map(m => {
              const [c1, c2] = betterClass(h1[m.key], h2[m.key], m.lowerBetter);
              return `
              <tr>
                <td class="compare-metric">${m.label}</td>
                <td class="compare-value ${c1}">${m.format(h1[m.key])}</td>
                <td class="compare-value ${c2}">${m.format(h2[m.key])}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    /* ── Global detail handler (called from table rows) ── */

    function showDetail(name) {
      const h = HOSPITALS.find(h => h.name === name);
      if (!h) return;
      renderDetail(h);
      injectViewingContext(name);
    }

    /* ── Bidirectional context ── */

    function injectViewingContext(name) {
      const empty = chatMessages.querySelector('.chat-empty');
      if (empty) empty.remove();

      const el = document.createElement('div');
      el.className = 'msg msg-context';
      el.textContent = `Viewing ${name}`;
      chatMessages.appendChild(el);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      conversationMessages.push({
        role: 'user',
        content: `[User is now viewing the detail card for ${name}]`
      });
    }

    /* ── Shared tool definitions ── */

    const TOOL_DEFS = [
      {
        name: 'filter_hospitals',
        description: 'Filter and display California hospitals on the page. Renders a table showing matching hospitals with risk tier, Medi-Cal share, equity burden score, and operating margin. The user can then click any row to see full details.',
        readOnlyHint: true,
        schema: {
          type: 'object',
          properties: {
            county: { type: 'string', enum: ['Los Angeles', 'San Francisco', 'Sacramento', 'San Diego'], description: 'Filter by county' },
            risk: { type: 'string', enum: ['low', 'medium', 'high'], description: 'Filter by ML-predicted risk tier' },
            search: { type: 'string', description: 'Search hospital name (partial match)' }
          }
        },
        exec: async (input) => {
          const filtered = filterData(input);
          const parts = [];
          if (input.county) parts.push(`in ${input.county}`);
          if (input.risk) parts.push(`${input.risk} risk`);
          if (input.search) parts.push(`matching "${input.search}"`);
          const label = parts.length ? parts.join(', ') : 'all hospitals';
          renderTable(filtered, label);
          return { displayed: true, count: filtered.length, summary: `Rendered ${filtered.length} hospitals (${label}). User can now see the table and click any row for details.` };
        }
      },
      {
        name: 'show_risk_chart',
        description: 'Display a visual bar chart showing the distribution of hospital financial risk tiers (low/medium/high). Renders directly on the page so the user can see the breakdown visually.',
        readOnlyHint: true,
        schema: {
          type: 'object',
          properties: {
            county: { type: 'string', enum: ['Los Angeles', 'San Francisco', 'Sacramento', 'San Diego'], description: 'Limit chart to a specific county' }
          }
        },
        exec: async (input) => {
          const hospitals = input.county ? filterData({ county: input.county }) : HOSPITALS;
          const label = input.county || 'all hospitals';
          renderChart(hospitals, label);
          const tiers = { low: 0, medium: 0, high: 0 };
          hospitals.forEach(h => tiers[riskTier(h.riskProbability)]++);
          return { displayed: true, summary: `Chart displayed: ${tiers.low} low, ${tiers.medium} medium, ${tiers.high} high risk (${label}).`, distribution: tiers };
        }
      },
      {
        name: 'show_hospital_detail',
        description: 'Display a detailed profile card for a specific hospital, showing risk probability, equity burden score, operating margin, payer mix breakdown, occupancy, and bed count. Renders visually on the page.',
        readOnlyHint: true,
        schema: {
          type: 'object',
          properties: {
            name: { type: 'string', description: 'Hospital name (partial match supported)' }
          },
          required: ['name']
        },
        exec: async (input) => {
          const hospital = HOSPITALS.find(h => matchName(h, input.name));
          if (!hospital) return { displayed: false, summary: `No hospital found matching "${input.name}".` };
          renderDetail(hospital);
          const tier = riskTier(hospital.riskProbability);
          return { displayed: true, summary: `Showing ${hospital.name} — ${tier} risk, equity burden ${hospital.equityBurdenScore}/100, margin ${fmt(hospital.operatingMargin)}%.` };
        }
      },
      {
        name: 'flag_hospital',
        description: 'Flag or unflag a hospital with a note. Flagged hospitals display an amber indicator dot in tables and detail views. Use this to mark hospitals that warrant attention or follow-up.',
        readOnlyHint: false,
        schema: {
          type: 'object',
          properties: {
            name: { type: 'string', description: 'Hospital name (partial match supported)' },
            note: { type: 'string', description: 'Reason for flagging (displayed on detail card)' },
            unflag: { type: 'boolean', description: 'Set to true to remove the flag' }
          },
          required: ['name']
        },
        exec: async (input) => {
          const hospital = HOSPITALS.find(h => matchName(h, input.name));
          if (!hospital) return { summary: `No hospital found matching "${input.name}".` };

          if (input.unflag) {
            flaggedHospitals.delete(hospital.name);
            refreshCurrentView();
            return { summary: `Removed flag from ${hospital.name}.` };
          }

          flaggedHospitals.set(hospital.name, {
            note: input.note || 'Flagged for review',
            timestamp: Date.now()
          });
          refreshCurrentView();
          return { summary: `Flagged ${hospital.name}: "${input.note || 'Flagged for review'}".` };
        }
      },
      {
        name: 'compare_hospitals',
        description: 'Display a side-by-side comparison table of two hospitals across key metrics: risk probability, equity burden, operating margin, Medi-Cal share, occupancy rate, and licensed beds. Better values are highlighted in green.',
        readOnlyHint: true,
        schema: {
          type: 'object',
          properties: {
            hospital1: { type: 'string', description: 'First hospital name (partial match)' },
            hospital2: { type: 'string', description: 'Second hospital name (partial match)' }
          },
          required: ['hospital1', 'hospital2']
        },
        exec: async (input) => {
          const h1 = HOSPITALS.find(h => matchName(h, input.hospital1));
          const h2 = HOSPITALS.find(h => matchName(h, input.hospital2));
          if (!h1) return { displayed: false, summary: `No hospital found matching "${input.hospital1}".` };
          if (!h2) return { displayed: false, summary: `No hospital found matching "${input.hospital2}".` };
          renderComparison(h1, h2);
          return { displayed: true, summary: `Comparing ${h1.name} vs ${h2.name}. Key differences: risk ${pct(h1.riskProbability * 100)} vs ${pct(h2.riskProbability * 100)}, margin ${fmt(h1.operatingMargin)}% vs ${fmt(h2.operatingMargin)}%.` };
        }
      }
    ];

    /* ── Button controls (mirror tool functionality) ── */

    document.querySelectorAll('.chip[data-filter]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');

        const filter = btn.dataset.filter;
        if (filter === 'all') {
          renderTable(HOSPITALS);
        } else if (filter === 'high') {
          const filtered = filterData({ risk: 'high' });
          renderTable(filtered, 'high-risk hospitals');
        } else {
          const filtered = filterData({ county: filter });
          renderTable(filtered, `hospitals in ${filter}`);
        }
      });
    });

    document.querySelector('.chip[data-view="chart"]').addEventListener('click', () => {
      document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
      document.querySelector('.chip[data-view="chart"]').classList.add('active');
      renderChart(HOSPITALS);
    });

    /* ── WebMCP registration ── */

    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');

    function registerTools() {
      if (!('modelContext' in navigator)) {
        statusText.textContent = 'WebMCP not detected';
        return;
      }

      statusDot.classList.add('active');
      statusText.textContent = 'WebMCP active';

      navigator.modelContext.provideContext({
        tools: TOOL_DEFS.map(t => ({
          name: t.name,
          description: t.description,
          inputSchema: t.schema,
          annotations: { readOnlyHint: t.readOnlyHint },
          execute: t.exec
        }))
      });
    }

    /* ── Chat panel ── */

    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');
    const chatReset = document.getElementById('chat-reset');
    const apiKeyInput = document.getElementById('api-key');
    const keyToggle = document.getElementById('key-toggle');

    const SYSTEM_PROMPT = `You are embedded in a WebMCP proof-of-concept that explores California hospital financial data. Your tools render visuals (tables, charts, detail cards, comparisons) directly on the page — the user already sees the full result. You only receive a brief summary.

Rules:
- 1-2 sentences max after a tool call. Never redescribe what the visualization already shows.
- Call tools eagerly. If the user asks to see data, call the tool — don't narrate what you're about to do.
- End with a short follow-up suggestion (one line) so the user knows what else they can explore.
- No markdown formatting — this renders as plain text in a chat bubble.
- No greetings, filler, or preamble.
- You can flag hospitals to mark them for attention. Use flag_hospital when the user wants to mark, note, or bookmark a hospital.
- You can compare two hospitals side-by-side. Use compare_hospitals when the user wants to see differences.`;
    const CLAUDE_TOOLS = TOOL_DEFS.map(t => ({ name: t.name, description: t.description, input_schema: t.schema }));

    let conversationMessages = [];
    let chatBusy = false;

    // Restore API key from sessionStorage
    apiKeyInput.value = sessionStorage.getItem('webmcp-api-key') || '';
    apiKeyInput.addEventListener('input', () => sessionStorage.setItem('webmcp-api-key', apiKeyInput.value));

    keyToggle.addEventListener('click', () => {
      const hidden = apiKeyInput.type === 'password';
      apiKeyInput.type = hidden ? 'text' : 'password';
      keyToggle.textContent = hidden ? 'Hide' : 'Show';
    });

    // Chat reset
    chatReset.addEventListener('click', () => {
      conversationMessages = [];
      chatMessages.innerHTML = '<div class="chat-empty">Ask a question about California hospital data.</div>';
    });

    // Auto-resize textarea
    chatInput.addEventListener('input', () => {
      chatInput.style.height = 'auto';
      chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
    });

    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    chatSend.addEventListener('click', sendMessage);

    function appendMessage(type, content) {
      const empty = chatMessages.querySelector('.chat-empty');
      if (empty) empty.remove();

      const el = document.createElement('div');
      el.className = `msg msg-${type}`;
      el.textContent = content;
      chatMessages.appendChild(el);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return el;
    }

    function appendToolMsg(toolName, args, result) {
      const empty = chatMessages.querySelector('.chat-empty');
      if (empty) empty.remove();

      const el = document.createElement('div');
      el.className = 'msg msg-tool';
      el.innerHTML = `<span class="msg-tool-name">${toolName}</span>(${JSON.stringify(args)})\n<span class="msg-tool-result">&rarr; ${result}</span>`;
      chatMessages.appendChild(el);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showSpinner() {
      const el = document.createElement('div');
      el.className = 'chat-spinner';
      el.id = 'chat-spinner';
      chatMessages.appendChild(el);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideSpinner() {
      const s = document.getElementById('chat-spinner');
      if (s) s.remove();
    }

    function setInputEnabled(enabled) {
      chatBusy = !enabled;
      chatSend.disabled = !enabled;
      chatInput.disabled = !enabled;
    }

    async function sendMessage() {
      const text = chatInput.value.trim();
      const apiKey = apiKeyInput.value.trim();
      if (!text || chatBusy) return;

      if (!apiKey) {
        appendMessage('error', 'Enter your Anthropic API key above.');
        return;
      }

      appendMessage('user', text);
      chatInput.value = '';
      chatInput.style.height = 'auto';

      conversationMessages.push({ role: 'user', content: text });
      setInputEnabled(false);
      showSpinner();

      await runConversation(apiKey);

      setInputEnabled(true);
      chatInput.focus();
    }

    /* ── Streaming API ── */

    async function streamClaudeAPI(apiKey, messages) {
      const res = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-haiku-4-5-20251001',
          max_tokens: 1024,
          system: SYSTEM_PROMPT,
          messages,
          tools: CLAUDE_TOOLS,
          stream: true
        })
      });

      if (!res.ok) {
        const body = await res.text();
        throw new Error(`API ${res.status}: ${body.slice(0, 200)}`);
      }

      return res.body;
    }

    async function* parseSSEStream(body) {
      const reader = body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });

        const lines = buffer.split('\n');
        buffer = lines.pop();

        let currentEvent = null;
        for (const line of lines) {
          if (line.startsWith('event: ')) {
            currentEvent = line.slice(7).trim();
          } else if (line.startsWith('data: ')) {
            const data = line.slice(6);
            if (data && currentEvent) {
              try {
                yield { event: currentEvent, data: JSON.parse(data) };
              } catch {}
            }
            currentEvent = null;
          }
        }
      }
    }

    async function runConversation(apiKey) {
      while (true) {
        let body;
        try {
          body = await streamClaudeAPI(apiKey, conversationMessages);
        } catch (err) {
          hideSpinner();
          appendMessage('error', err.message);
          return;
        }

        // Parse the stream
        const contentBlocks = [];
        let currentTextEl = null;
        let currentTextContent = '';
        let currentToolInput = '';
        let currentBlockType = null;
        let stopReason = null;

        for await (const { event, data } of parseSSEStream(body)) {
          switch (event) {
            case 'content_block_start': {
              const block = data.content_block;
              currentBlockType = block.type;
              if (block.type === 'text') {
                hideSpinner();
                currentTextContent = block.text || '';
                currentTextEl = appendMessage('assistant', currentTextContent);
              } else if (block.type === 'tool_use') {
                contentBlocks.push({ type: 'tool_use', id: block.id, name: block.name, input: {} });
                currentToolInput = '';
              }
              break;
            }

            case 'content_block_delta': {
              if (data.delta.type === 'text_delta') {
                currentTextContent += data.delta.text;
                if (currentTextEl) currentTextEl.textContent = currentTextContent;
                chatMessages.scrollTop = chatMessages.scrollHeight;
              } else if (data.delta.type === 'input_json_delta') {
                currentToolInput += data.delta.partial_json;
              }
              break;
            }

            case 'content_block_stop': {
              if (currentBlockType === 'text' && currentTextContent) {
                contentBlocks.push({ type: 'text', text: currentTextContent });
                currentTextEl = null;
                currentTextContent = '';
              } else if (currentBlockType === 'tool_use') {
                const toolBlock = contentBlocks[contentBlocks.length - 1];
                try {
                  toolBlock.input = currentToolInput ? JSON.parse(currentToolInput) : {};
                } catch {
                  toolBlock.input = {};
                }
                currentToolInput = '';
              }
              currentBlockType = null;
              break;
            }

            case 'message_delta': {
              if (data.delta?.stop_reason) stopReason = data.delta.stop_reason;
              break;
            }
          }
        }

        // Add the full assistant message to conversation history
        conversationMessages.push({ role: 'assistant', content: contentBlocks });

        // Check for tool use
        const toolUses = contentBlocks.filter(b => b.type === 'tool_use');
        if (toolUses.length === 0) {
          hideSpinner();
          return;
        }

        // Execute tools and gather results
        const toolResults = [];
        for (const tu of toolUses) {
          const def = TOOL_DEFS.find(t => t.name === tu.name);
          let result;
          if (def) {
            result = await def.exec(tu.input);
            appendToolMsg(tu.name, tu.input, result.summary);
            scrollDisplayIntoView();
          } else {
            result = { error: `Unknown tool: ${tu.name}` };
          }
          toolResults.push({
            type: 'tool_result',
            tool_use_id: tu.id,
            content: JSON.stringify(result)
          });
        }

        conversationMessages.push({ role: 'user', content: toolResults });
        showSpinner();
        // Loop to send tool results back
      }
    }

    /* ── Init ── */

    async function init() {
      renderSkeleton();

      try {
        const res = await fetch('hospitals.json');
        HOSPITALS = await res.json();
      } catch (err) {
        display.innerHTML = `<p class="msg-error">Failed to load hospital data: ${err.message}</p>`;
        return;
      }

      renderTable(HOSPITALS);
      registerTools();
    }

    init();
  </script>
</body>
</html>
